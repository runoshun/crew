[tools]
go = "1.25"
golangci-lint = "2"

[tasks.build]
description = "Build crew binary"
run = "go build -o crew ./cmd/crew"

[tasks.test]
description = "Run tests"
run = "go test -v ./..."

[tasks.lint]
description = "Run golangci-lint"
run = "golangci-lint run ./..."

[tasks."test:race"]
description = "Run tests with race detector"
run = "go test -race ./..."

[tasks."test:cover"]
description = "Run tests with coverage"
run = "go test -race -coverprofile=coverage.out ./..."

[tasks."test:integration"]
description = "Run integration tests"
run = "go test -tags=integration ./internal/cli/... -run TestIntegration"

[tasks."test:integration:cover"]
description = "Run integration tests with coverage"
run = """
rm -rf /tmp/crew-covdata && mkdir -p /tmp/crew-covdata
GOCOVERDIR_OUT=/tmp/crew-covdata go test -tags=integration ./internal/cli/... -run TestIntegration
go tool covdata textfmt -i=/tmp/crew-covdata -o=coverage-integration.out
echo "Coverage report: coverage-integration.out"
echo ""
go tool cover -func=coverage-integration.out | tail -5
"""

[tasks.vuln]
description = "Check for vulnerabilities"
run = "go run golang.org/x/vuln/cmd/govulncheck@latest ./..."

[tasks.ci]
description = "Run CI checks (lint + test with race)"
depends = ["lint", "test:race"]

[tasks."ci:full"]
description = "Full CI with coverage and vuln check"
depends = ["lint", "test:cover", "vuln"]

[tasks.fmt]
description = "Format code"
run = "gofmt -s -w ."

[tasks.tidy]
description = "Tidy go.mod"
run = "go mod tidy"

[tasks.install]
description = "Install to ~/.local/bin"
depends = ["build"]
run = "rm -f ~/.local/bin/crew && cp crew ~/.local/bin/"

[tasks.clean]
description = "Clean build artifacts"
run = "rm -f crew coverage.out coverage.html"
